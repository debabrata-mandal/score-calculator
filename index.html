<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>‚≠ê Rummy Score Master</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 1000px;
        margin: auto;
      }      
      /* Dynamic header sizing */
      h1 {
        white-space: nowrap;
        overflow: hidden;
        font-size: clamp(1.2rem, 4vw, 2rem);
        margin: 0 0 20px 0;
      }
      
      table {
        border-collapse: collapse;
        margin-top: 20px;
        width: 100%;
        overflow-x: auto;
        display: block;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 4px;
        text-align: center;
      }
      input[type="number"] {
        width: 50px;
      }
      input[type="text"] {
        width: 100%;
        min-width: 100px;
      }
      .leaderboard,
      .chart-container {
        margin-top: 30px;
      }
      .controls {
        margin-bottom: 10px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }
      button {
        padding: 6px 12px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #c82333;
      }
      canvas {
        max-width: 100%;
        height: auto;
      }

      @media (max-width: 768px) {
        h1 {
          font-size: clamp(1rem, 5vw, 1.5rem);
        }
        input[type="text"] {
          width: 100%;
          min-width: 120px;
          font-size: 14px;
        }
        input[type="number"] {
          width: 40px;
          font-size: 12px;
        }
        th,
        td {
          padding: 2px;
          font-size: 12px;
        }
        .controls {
          flex-direction: row;
          flex-wrap: wrap;
          align-items: center;
          gap: 5px;
        }
        .controls label {
          width: 100%;
          margin-bottom: 5px;
        }
        .controls input[type="number"] {
          width: 60px;
        }
        button {
          font-size: 12px;
          padding: 4px 8px;
        }
      }
      /* Custom Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: none;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .modal-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .modal-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .modal-button.confirm {
        background-color: #dc3545;
        color: white;
      }

      .modal-button.cancel {
        background-color: #6c757d;
        color: white;
      }

      .modal-button:hover {
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>‚≠ê Rummy Score Master</h1>
      <div class="controls">
        <label for="numPlayers">Number of Players (1-15): </label>
        <input type="number" id="numPlayers" min="1" max="15" value="2" />
        <button onclick="confirmGenerateTable()">Start Play</button>
        <button onclick="addPlayer()">Add Player</button>
      </div>

      <div id="scoreTableContainer"></div>
      <div class="leaderboard" id="leaderboard"></div>
      <div class="chart-container">
        <canvas id="scoreChart"></canvas>
      </div>
    </div>
    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <h3 id="modalTitle">‚ö†Ô∏è Confirm Action</h3>
        <p id="modalMessage">Are you sure you want to proceed?</p>
        <div class="modal-buttons">
          <button class="modal-button confirm" onclick="confirmAction()">
            Yes, Proceed
          </button>
          <button class="modal-button cancel" onclick="closeModal()">
            Cancel
          </button>
        </div>
      </div>
    </div>
    <script>
      let chart;
      let pendingAction = null;

      function showModal(title, message, action) {
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalMessage").textContent = message;
        document.getElementById("confirmModal").style.display = "block";
        pendingAction = action;
      }

      function closeModal() {
        document.getElementById("confirmModal").style.display = "none";
        pendingAction = null;
      }

      function confirmAction() {
        if (pendingAction) {
          pendingAction();
        }
        closeModal();
      }

      function saveData() {
        const numPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        const data = { numPlayers, players: [] };
        for (let i = 1; i <= numPlayers; i++) {
          const nameInput = document.getElementById(`name${i}`);
          const name = nameInput.value.trim();
          const scores = [];
          for (let j = 1; j <= 10; j++) {
            const val =
              parseInt(document.getElementById(`p${i}r${j}`).value) || 0;
            scores.push(val);
          }
          data.players.push({ name, scores });
        }
        localStorage.setItem("scoreData", JSON.stringify(data));
      }

      function loadData() {
        const saved = localStorage.getItem("scoreData");
        if (!saved) return;
        const data = JSON.parse(saved);
        document.getElementById("numPlayers").value = data.numPlayers;
        generateTable(data);
      }

      function confirmGenerateTable() {
        showModal(
          "üéÆ Start New Game",
          "Are you sure you want to start a new game? This will reset all current scores.",
          () => {
            localStorage.removeItem("scoreData");
            generateTable();
          }
        );
      }

      function addPlayer() {
        const currentPlayers = parseInt(
          document.getElementById("numPlayers").value
        );

        if (currentPlayers >= 15) {
          showModal(
            "‚ö†Ô∏è Maximum Players Reached",
            "Maximum 15 players allowed!",
            null
          );
          return;
        }

        // Increase player count by 1
        document.getElementById("numPlayers").value = currentPlayers + 1;

        // Regenerate table with existing data preserved
        generateTable();
      }

      function generateTable(savedData = null) {
        const numPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        if (isNaN(numPlayers) || numPlayers < 1 || numPlayers > 15) {
          alert("Please enter a valid number of players (1-15).");
          return;
        }

        // Get existing data if not provided
        if (!savedData) {
          const saved = localStorage.getItem("scoreData");
          if (saved) {
            savedData = JSON.parse(saved);
          }
        }

        let html = "<table><thead><tr><th>Player Name</th>";
        for (let round = 1; round <= 10; round++) {
          html += `<th>R${round}</th>`;
        }
        html += "</tr></thead><tbody>";

        for (let i = 1; i <= numPlayers; i++) {
          // Use existing data if available, otherwise default values
          const name =
            savedData && savedData.players && savedData.players[i - 1]
              ? savedData.players[i - 1].name
              : `Player ${i}`;

          html += `<tr><td><input type="text" id="name${i}" value="${name}" oninput="saveData(); calculateScores();"></td>`;

          for (let j = 1; j <= 10; j++) {
            const val =
              savedData &&
              savedData.players &&
              savedData.players[i - 1] &&
              savedData.players[i - 1].scores
                ? savedData.players[i - 1].scores[j - 1] || 0
                : 0;
            html += `<td><input type="number" id="p${i}r${j}" value="${val}" min="0" max="100" oninput="saveData(); calculateScores();"></td>`;
          }
          html += "</tr>";
        }

        html += "</tbody></table>";
        document.getElementById("scoreTableContainer").innerHTML = html;
        saveData();
        calculateScores();
      }

      function calculateScores() {
        const numPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        const scores = [];

        for (let i = 1; i <= numPlayers; i++) {
          let total = 0;
          for (let j = 1; j <= 10; j++) {
            const val =
              parseInt(document.getElementById(`p${i}r${j}`).value) || 0;
            total += val;
          }
          const name = document.getElementById(`name${i}`).value.trim();
          scores.push({ name, total });
        }

        // Keep original order for chart
        const originalOrderScores = [...scores];

        // Sort for leaderboard (low score wins)
        const sortedScores = [...scores].sort((a, b) => a.total - b.total);

        // Create leaderboard as a sorted table with ranks
        let leaderboardHtml = `
    <h2>Leaderboard</h2>
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
      <thead>
        <tr style="background-color: #f8f9fa;">
          <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Rank</th>
          <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Player</th>
          <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Total Score</th>
        </tr>
      </thead>
      <tbody>`;

        sortedScores.forEach((score, index) => {
          leaderboardHtml += `
      <tr>
        <td style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">${
          index + 1
        }</td>
        <td style="border: 1px solid #ccc; padding: 8px;">${score.name}</td>
        <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${
          score.total
        }</td>
      </tr>`;
        });

        leaderboardHtml += `
      </tbody>
    </table>`;

        document.getElementById("leaderboard").innerHTML = leaderboardHtml;
        updateChart(originalOrderScores); // Pass original order to chart
      }

      function updateChart(scores) {
        const ctx = document.getElementById("scoreChart").getContext("2d");
        const labels = scores.map((s) => s.name);
        const data = scores.map((s) => s.total);

        const backgroundColors = data.map((score) => {
          if (score <= 40) {
            const green = Math.round(255 - (score / 40) * 155); // 255 to 100
            return `rgb(0, ${green}, 0)`;
          } else if (score <= 60) {
            const yellow = Math.round(255 - ((score - 40) / 20) * 155); // 255 to 100
            return `rgb(${yellow}, ${yellow}, 0)`;
          } else {
            const red = Math.round(100 + ((score - 60) / 40) * 155); // 100 to 255
            return `rgb(${red}, 0, 0)`;
          }
        });

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Total Score",
                data: data,
                backgroundColor: backgroundColors,
                borderColor: "rgba(0,0,0,0.1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
      }

      window.onload = loadData;
    </script>
  </body>
</html>