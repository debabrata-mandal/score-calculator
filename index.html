<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>‚≠ê Rummy Score Master</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 1000px;
        margin: auto;
      }

      /* Dynamic header sizing */
      h1 {
        white-space: nowrap;
        overflow: hidden;
        font-size: clamp(1.2rem, 4vw, 2rem);
        margin: 0 0 20px 0;
      }

      /* Table container for horizontal scroll */
      .table-container {
        overflow-x: auto;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      table {
        border-collapse: collapse;
        margin-top: 0; /* Changed from 10px to 0 */
        width: 100%;
        min-width: 800px;
      }

      /* First column (Player Name) - frozen */
      table th:first-child,
      table td:first-child {
        position: sticky;
        left: 0;
        background-color: #fff;
        z-index: 10;
        min-width: 150px;
        max-width: 150px;
        width: 150px;
      }

      table th:first-child {
        background-color: #f8f9fa;
        z-index: 11;
      }

      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
        min-width: 60px;
      }

      /* Bigger inputs for better user experience */
      input[type="number"] {
        width: 60px;
        padding: 6px;
        font-size: 14px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      input[type="text"] {
        width: 100%;
        min-width: 120px;
        padding: 6px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      /* Input fields in tables - transparent styling */
      table input[type="number"],
      table input[type="text"] {
        border: none;
        background: transparent;
        width: 100%;
        padding: 4px;
        font-size: 14px;
      }

      table input[type="number"] {
        text-align: center;
      }

      .leaderboard,
      .chart-container {
        margin-top: 30px;
      }

      .controls {
        margin-bottom: 10px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }

      button {
        padding: 8px 16px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      button:hover {
        background-color: #c82333;
      }

      /* Special styling for the Start Play button */
      .start-play-button {
        padding: 12px 24px !important;
        font-size: 16px !important;
        font-weight: bold !important;
        background-color: #007bff !important;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3) !important;
        transition: all 0.3s ease !important;
      }

      .start-play-button:hover {
        background-color: #0056b3 !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4) !important;
      }

      canvas {
        max-width: 100%;
        height: auto;
      }

      @media (max-width: 768px) {
        h1 {
          font-size: clamp(1rem, 5vw, 1.5rem);
        }

        /* First column smaller on mobile */
        table th:first-child,
        table td:first-child {
          min-width: 120px;
          max-width: 120px;
          width: 120px;
        }

        input[type="text"] {
          width: 100%;
          min-width: 100px;
          font-size: 13px;
          padding: 4px;
        }

        input[type="number"] {
          width: 55px;
          font-size: 12px;
          padding: 4px;
        }

        th,
        td {
          padding: 4px;
          font-size: 11px;
          min-width: 50px;
        }

        table input[type="number"],
        table input[type="text"] {
          font-size: 12px;
          padding: 2px;
        }

        table input[type="number"] {
          min-width: 45px;
          width: 100%;
        }

        .controls {
          flex-direction: row; /* Keep row direction instead of column */
          flex-wrap: wrap;
          align-items: center;
          gap: 5px;
        }

        .controls label {
          width: auto; /* Changed from 100% to auto */
          margin-bottom: 0; /* Changed from 5px to 0 */
          white-space: nowrap; /* Prevent label from wrapping */
        }

        .controls input[type="number"] {
          width: 60px;
        }

        button {
          font-size: 12px;
          padding: 6px 12px;
        }

        .start-play-button {
          padding: 10px 20px !important;
          font-size: 15px !important;
        }
      }

      /* Custom Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: none;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .modal-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }

      .modal-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .modal-button.confirm {
        background-color: #dc3545;
        color: white;
      }

      .modal-button.cancel {
        background-color: #6c757d;
        color: white;
      }

      .modal-button:hover {
        opacity: 0.9;
      }
      .leaderboard-table,
      .leaderboard-table * {
        position: static !important;
        left: auto !important;
        z-index: auto !important;
        background-color: transparent !important;
      }

      .leaderboard-table th:first-child,
      .leaderboard-table td:first-child {
        position: static !important;
        left: auto !important;
        background-color: transparent !important;
        z-index: auto !important;
        width: auto !important;
        min-width: auto !important;
        max-width: auto !important;
      }

      .leaderboard-table th:first-child {
        background-color: #f8f9fa !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>‚≠ê Rummy Score Master</h1>
      <div class="controls">
        <label for="numPlayers">Players (1-15): </label>
        <input type="number" id="numPlayers" min="1" max="15" value="2" />
      </div>

      <div style="text-align: center; margin: 20px 0;">
        <button class="start-play-button" onclick="confirmGenerateTable()">
          üéÆ Start Play
        </button>
      </div>

      <div id="scoreTableContainer"></div>
      <div class="leaderboard" id="leaderboard"></div>
      <div class="chart-container">
        <canvas id="scoreChart"></canvas>
      </div>
    </div>
    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <h3 id="modalTitle">‚ö†Ô∏è Confirm Action</h3>
        <p id="modalMessage">Are you sure you want to proceed?</p>
        <div class="modal-buttons">
          <button class="modal-button confirm" onclick="confirmAction()">
            Yes, Proceed
          </button>
          <button class="modal-button cancel" onclick="closeModal()">
            Cancel
          </button>
        </div>
      </div>
    </div>
    <script>
      let chart;
      let pendingAction = null;

      function showModal(title, message, action) {
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalMessage").textContent = message;
        document.getElementById("confirmModal").style.display = "block";
        pendingAction = action;
      }

      function closeModal() {
        document.getElementById("confirmModal").style.display = "none";
        pendingAction = null;
      }

      function confirmAction() {
        if (pendingAction) {
          pendingAction();
        }
        closeModal();
      }

      function saveData() {
        const numPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        const data = { numPlayers, players: [] };
        for (let i = 1; i <= numPlayers; i++) {
          const nameInput = document.getElementById(`name${i}`);
          const name = nameInput.value.trim();
          const scores = [];
          for (let j = 1; j <= 10; j++) {
            const val = parseInt(document.getElementById(`p${i}r${j}`).value);
            scores.push(isNaN(val) ? -1 : val);
          }
          data.players.push({ name, scores });
        }
        localStorage.setItem("scoreData", JSON.stringify(data));
      }

      function loadData() {
        const saved = localStorage.getItem("scoreData");
        if (!saved) return;
        const data = JSON.parse(saved);
        document.getElementById("numPlayers").value = data.numPlayers;
        generateTable(data);
      }

      function confirmGenerateTable() {
        showModal(
          "üéÆ Start New Game",
          "Are you sure you want to start a new game? This will reset all current scores.",
          () => {
            localStorage.removeItem("scoreData");
            generateTable();
          }
        );
      }

      function addPlayer() {
        const currentPlayers = parseInt(
          document.getElementById("numPlayers").value
        );

        if (currentPlayers >= 15) {
          showModal(
            "‚ö†Ô∏è Maximum Players Reached",
            "Maximum 15 players allowed!",
            null
          );
          return;
        }

        // Increase player count by 1
        document.getElementById("numPlayers").value = currentPlayers + 1;

        // Regenerate table with existing data preserved
        generateTable();
      }

      // Update the generateTable function to include the Add Player button at the end
      function generateTable(savedData = null) {
        const numPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        if (isNaN(numPlayers) || numPlayers < 1 || numPlayers > 15) {
          alert("Please enter a valid number of players (1-15).");
          return;
        }

        // Get existing data if not provided
        if (!savedData) {
          const saved = localStorage.getItem("scoreData");
          if (saved) {
            savedData = JSON.parse(saved);
          }
        }

        let html = `
    <h2>Score</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr style="background-color: #f8f9fa;">
            <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Player Name</th>`;

        for (let round = 1; round <= 10; round++) {
          html += `<th style="border: 1px solid #ccc; padding: 8px; text-align: center;">R${round}</th>`;
        }
        html += `</tr></thead><tbody>`;

        for (let i = 1; i <= numPlayers; i++) {
          // Use existing data if available, otherwise default values
          const name =
            savedData && savedData.players && savedData.players[i - 1]
              ? savedData.players[i - 1].name
              : `Player ${i}`;

          html += `<tr><td style="border: 1px solid #ccc; padding: 8px;"><input type="text" id="name${i}" value="${name}" oninput="saveData(); calculateScores();" style="border: none; background: transparent; width: 100%; padding: 4px; font-size: 14px;"></td>`;

          for (let j = 1; j <= 10; j++) {
            const val =
              savedData &&
              savedData.players &&
              savedData.players[i - 1] &&
              savedData.players[i - 1].scores
                ? savedData.players[i - 1].scores[j - 1] !== undefined 
                  ? savedData.players[i - 1].scores[j - 1] 
                  : -1
                : -1;
            html += `<td style="border: 1px solid #ccc; padding: 8px; text-align: center; min-width: 60px;"><input type="number" id="p${i}r${j}" value="${val}" min="-1" max="100" oninput="saveData(); calculateScores();" style="border: none; background: transparent; width: 100%; text-align: center; padding: 4px; font-size: 14px; min-width: 50px;"></td>`;
          }
          html += "</tr>";
        }

        html += "</tbody></table></div>";
        
        // Add the "Add Player" button after the table
        html += `
    <div style="margin-top: 10px;">
      <button onclick="addPlayer()" style="padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
        + Add Player
      </button>
    </div>`;

        document.getElementById("scoreTableContainer").innerHTML = html;
        saveData();
        calculateScores();
      }

      function calculateScores() {
        const numPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        const scores = [];

        for (let i = 1; i <= numPlayers; i++) {
          let total = 0;
          for (let j = 1; j <= 10; j++) {
            const val = parseInt(document.getElementById(`p${i}r${j}`).value);
            // Treat -1 as 0 for calculation, but preserve -1 in the input
            total += isNaN(val) || val === -1 ? 0 : val;
          }
          const name = document.getElementById(`name${i}`).value.trim();
          scores.push({ name, total });
        }

        // Keep original order for chart
        const originalOrderScores = [...scores];

        // Sort for leaderboard (low score wins)
        const sortedScores = [...scores].sort((a, b) => a.total - b.total);

        // Create leaderboard table that fits in visible area
        let leaderboardHtml = `
    <h2>Leaderboard</h2>
    <table class="leaderboard-table" style="
      width: auto !important; 
      min-width: auto !important; 
      max-width: 300px !important; 
      border-collapse: collapse; 
      margin-top: 10px; 
      display: table !important;
      table-layout: auto !important;
    ">
      <thead>
        <tr style="background-color: #f8f9fa;">
          <th style="border: 1px solid #ccc; padding: 6px; text-align: center; width: 40px !important; min-width: 40px !important; max-width: 40px !important; font-size: 12px;">#</th>
          <th style="border: 1px solid #ccc; padding: 6px; text-align: left; width: auto !important; min-width: 80px !important; max-width: 120px !important; font-size: 12px;">Player</th>
          <th style="border: 1px solid #ccc; padding: 6px; text-align: center; width: 50px !important; min-width: 50px !important; max-width: 50px !important; font-size: 12px;">Score</th>
        </tr>
      </thead>
      <tbody>`;

        sortedScores.forEach((score, index) => {
          leaderboardHtml += `
      <tr>
        <td style="border: 1px solid #ccc; padding: 6px; text-align: center; font-weight: bold; width: 40px !important; min-width: 40px !important; max-width: 40px !important; font-size: 12px;">${
          index + 1
        }</td>
        <td style="border: 1px solid #ccc; padding: 6px; width: auto !important; min-width: 80px !important; max-width: 120px !important; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${score.name}</td>
        <td style="border: 1px solid #ccc; padding: 6px; text-align: center; width: 50px !important; min-width: 50px !important; max-width: 50px !important; font-size: 12px;">${
          score.total
        }</td>
      </tr>`;
        });

        leaderboardHtml += `
      </tbody>
    </table>`;

        document.getElementById("leaderboard").innerHTML = leaderboardHtml;
        updateChart(originalOrderScores); // Pass original order to chart
      }

      function updateChart(scores) {
        const ctx = document.getElementById("scoreChart").getContext("2d");
        const labels = scores.map((s) => s.name);
        const data = scores.map((s) => s.total);

        // Find min and max scores for relative coloring
        const minScore = Math.min(...data);
        const maxScore = Math.max(...data);
        const range = maxScore - minScore;

        const backgroundColors = data.map((score) => {
          if (range === 0) {
            // All scores are the same
            return 'rgb(128, 128, 128)'; // Gray
          }
          
          // Calculate relative position (0 = best, 1 = worst)
          const position = (score - minScore) / range;
          
          if (position <= 0.33) {
            // Best third - Green shades (darker green for better scores)
            const green = Math.round(255 - (position * 0.33 * 100)); // 255 to 155
            return `rgb(0, ${green}, 0)`;
          } else if (position <= 0.66) {
            // Middle third - Yellow/Orange shades
            const progress = (position - 0.33) / 0.33; // 0 to 1 within this range
            const red = Math.round(255);
            const green = Math.round(255 - (progress * 127)); // 255 to 128
            return `rgb(${red}, ${green}, 0)`;
          } else {
            // Worst third - Red shades (darker red for worse scores)
            const progress = (position - 0.66) / 0.34; // 0 to 1 within this range
            const red = Math.round(200 + (progress * 55)); // 200 to 255
            return `rgb(${red}, 0, 0)`;
          }
        });

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Total Score",
                data: data,
                backgroundColor: backgroundColors,
                borderColor: "rgba(0,0,0,0.2)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: { 
                beginAtZero: true
              },
              x: {
                // Removed title
              }
            },
          },
        });
      }

      window.onload = loadData;
    </script>
  </body>
</html>
