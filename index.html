<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>⭐ Rummy Score Master</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 1000px;
        margin: auto;
      }
      table {
        border-collapse: collapse;
        margin-top: 20px;
        width: 100%;
        overflow-x: auto;
        display: block;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 4px;
        text-align: center;
      }
      input[type="number"] {
        width: 50px;
      }
      input[type="text"] {
        width: 100%;
        min-width: 100px;
      }
      .leaderboard,
      .chart-container {
        margin-top: 30px;
      }
      .controls {
        margin-bottom: 10px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }
      button {
        padding: 6px 12px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #c82333;
      }
      canvas {
        max-width: 100%;
        height: auto;
      }

      @media (max-width: 768px) {
        input[type="text"] {
          width: 100%;
          min-width: 120px;
          font-size: 14px;
        }
        input[type="number"] {
          width: 40px;
          font-size: 12px;
        }
        th,
        td {
          padding: 2px;
          font-size: 12px;
        }
        .controls {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>⭐ Rummy Score Master (up to 15 Players)</h1>
      <div class="controls">
        <label for="numPlayers">Number of Players (1-15): </label>
        <input type="number" id="numPlayers" min="1" max="15" value="2" />
        <button onclick="confirmGenerateTable()">Generate Score Table</button>
      </div>

      <div id="scoreTableContainer"></div>
      <div class="leaderboard" id="leaderboard"></div>
      <div class="chart-container">
        <canvas id="scoreChart"></canvas>
      </div>
    </div>
    <script>
      let chart;

      function saveData() {
        const numPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        const data = { numPlayers, players: [] };
        for (let i = 1; i <= numPlayers; i++) {
          const nameInput = document.getElementById(`name${i}`);
          const name = nameInput.value.trim();
          const scores = [];
          for (let j = 1; j <= 10; j++) {
            const val =
              parseInt(document.getElementById(`p${i}r${j}`).value) || 0;
            scores.push(val);
          }
          data.players.push({ name, scores });
        }
        localStorage.setItem("scoreData", JSON.stringify(data));
      }

      function loadData() {
        const saved = localStorage.getItem("scoreData");
        if (!saved) return;
        const data = JSON.parse(saved);
        document.getElementById("numPlayers").value = data.numPlayers;
        generateTable(data);
      }

      function confirmGenerateTable() {
        if (
          confirm(
            "⚠️ Are you sure you want to regenerate the score table? This will reset all current scores."
          )
        ) {
          generateTable();
        }
      }

      function confirmGenerateTable() {
        const currentPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        const savedData = localStorage.getItem("scoreData");

        if (savedData) {
          const data = JSON.parse(savedData);
          if (currentPlayers > data.numPlayers) {
            // Adding players - no confirmation needed
            generateTable();
          } else if (currentPlayers < data.numPlayers) {
            // Removing players - ask for confirmation
            if (
              confirm(
                "⚠️ Reducing players will remove some player data. Continue?"
              )
            ) {
              generateTable();
            }
          } else {
            // Same number - ask for confirmation to reset
            if (
              confirm(
                "⚠️ Are you sure you want to regenerate the score table? This will reset all current scores."
              )
            ) {
              generateTable();
            }
          }
        } else {
          // No saved data - just generate
          generateTable();
        }
      }

      function generateTable(savedData = null) {
        const numPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        if (isNaN(numPlayers) || numPlayers < 1 || numPlayers > 15) {
          alert("Please enter a valid number of players (1-15).");
          return;
        }

        // Get existing data if not provided
        if (!savedData) {
          const saved = localStorage.getItem("scoreData");
          if (saved) {
            savedData = JSON.parse(saved);
          }
        }

        let html = "<table><thead><tr><th>Player Name</th>";
        for (let round = 1; round <= 10; round++) {
          html += `<th>R${round}</th>`;
        }
        html += "</tr></thead><tbody>";

        for (let i = 1; i <= numPlayers; i++) {
          // Use existing data if available, otherwise default values
          const name =
            savedData && savedData.players && savedData.players[i - 1]
              ? savedData.players[i - 1].name
              : `Player ${i}`;

          html += `<tr><td><input type="text" id="name${i}" value="${name}" oninput="saveData(); calculateScores();"></td>`;

          for (let j = 1; j <= 10; j++) {
            const val =
              savedData &&
              savedData.players &&
              savedData.players[i - 1] &&
              savedData.players[i - 1].scores
                ? savedData.players[i - 1].scores[j - 1] || 0
                : 0;
            html += `<td><input type="number" id="p${i}r${j}" value="${val}" min="0" max="100" oninput="saveData(); calculateScores();"></td>`;
          }
          html += "</tr>";
        }

        html += "</tbody></table>";
        document.getElementById("scoreTableContainer").innerHTML = html;
        saveData();
        calculateScores();
      }

      function calculateScores() {
        const numPlayers = parseInt(
          document.getElementById("numPlayers").value
        );
        const scores = [];

        for (let i = 1; i <= numPlayers; i++) {
          let total = 0;
          for (let j = 1; j <= 10; j++) {
            const val =
              parseInt(document.getElementById(`p${i}r${j}`).value) || 0;
            total += val;
          }
          const name = document.getElementById(`name${i}`).value.trim();
          scores.push({ name, total });
        }

        // Keep original order for chart and leaderboard
        const originalOrderScores = [...scores];

        // Create a sorted copy just to determine rankings
        const sortedForRanking = [...scores].sort((a, b) => a.total - b.total); // Low score wins

        // Create leaderboard in original order with rankings
        let leaderboardHtml =
          "<h2>Leaderboard</h2><ul style='list-style: none; padding: 0;'>";
        originalOrderScores.forEach((score) => {
          // Find ranking (1-based)
          const ranking =
            sortedForRanking.findIndex(
              (s) => s.name === score.name && s.total === score.total
            ) + 1;
          leaderboardHtml += `<li style='margin: 5px 0;'>${score.name}: ${score.total} points (Rank #${ranking})</li>`;
        });
        leaderboardHtml += "</ul>";

        document.getElementById("leaderboard").innerHTML = leaderboardHtml;
        updateChart(originalOrderScores); // Pass original order to chart
      }

      function updateChart(scores) {
        const ctx = document.getElementById("scoreChart").getContext("2d");
        const labels = scores.map((s) => s.name);
        const data = scores.map((s) => s.total);

        const backgroundColors = data.map((score) => {
          if (score <= 40) {
            const green = Math.round(255 - (score / 40) * 155); // 255 to 100
            return `rgb(0, ${green}, 0)`;
          } else if (score <= 60) {
            const yellow = Math.round(255 - ((score - 40) / 20) * 155); // 255 to 100
            return `rgb(${yellow}, ${yellow}, 0)`;
          } else {
            const red = Math.round(100 + ((score - 60) / 40) * 155); // 100 to 255
            return `rgb(${red}, 0, 0)`;
          }
        });

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Total Score",
                data: data,
                backgroundColor: backgroundColors,
                borderColor: "rgba(0,0,0,0.1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
      }

      window.onload = loadData;
    </script>
  </body>
</html>
